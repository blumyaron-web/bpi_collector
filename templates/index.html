<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>BPI Collector — Terminal Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/terminal.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      function updateEmailStatus() {
        fetch('/email_status')
          .then(response => response.json())
          .then(data => {
            // Update latest email status
            const emailStatus = document.getElementById('email-status');
            const latestEmail = data.latest;
            
            if (latestEmail && (latestEmail.timestamp || latestEmail.last_send)) {
              // Use pre-formatted time if available, otherwise format on client-side
              let displayDate;
              if (latestEmail.formatted_time) {
                displayDate = latestEmail.formatted_time;
              } else {
                const timestamp = latestEmail.timestamp || latestEmail.last_send;
                const date = new Date(timestamp);
                // Convert to local timezone
                displayDate = date.toLocaleString([], {
                  year: 'numeric',
                  month: 'numeric',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit',
                  second: '2-digit',
                  hour12: false, // Use 24-hour format
                  timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone // Use the system timezone explicitly
                });
              }
              
              emailStatus.innerHTML = `Last Email: ${displayDate}<br>Subject: ${latestEmail.subject || 'No subject'}`;
              emailStatus.style.color = latestEmail.success ? '#4CAF50' : '#f44336';
            } else {
              emailStatus.textContent = 'Last Email: Not sent';
            }
            
            // Update email history
            const historyContainer = document.getElementById('email-history');
            historyContainer.innerHTML = '';
            
            if (data.history && data.history.length > 0) {
              const historyHtml = data.history.map((item, index) => {
                if (!item || (!item.timestamp && !item.last_send)) return '';
                
                // Use pre-formatted time if available, otherwise format on client-side
                let displayDate;
                if (item.formatted_time) {
                  displayDate = item.formatted_time.split(' ').slice(0, 4).join(' '); // Shorter format
                } else {
                  const timestamp = item.timestamp || item.last_send;
                  const date = new Date(timestamp);
                  // Convert to local timezone
                  displayDate = date.toLocaleString([], {
                    month: 'numeric',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false, // Use 24-hour format
                    timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone // Use the system timezone explicitly
                  });
                }
                
                const statusColor = item.success ? '#4CAF50' : '#f44336';
                const statusIcon = item.success ? '✓' : '✗';
                
                return `<div class="email-history-item">
                  <span class="email-status-icon" style="color: ${statusColor}">${statusIcon}</span>
                  <span class="email-date">${displayDate}</span>
                  <span class="email-subject">${item.subject || 'No subject'}</span>
                </div>`;
              }).join('');
              
              historyContainer.innerHTML = historyHtml;
            } else {
              historyContainer.innerHTML = '<div class="email-history-item">No email history</div>';
            }
          });
      }

      function updateProgress() {
        fetch('/progress')
          .then(response => response.json())
          .then(data => {
            const progressBar = document.getElementById('collection-progress');
            const progressText = document.getElementById('progress-text');
            const percentage = (data.samples_collected / data.total_samples) * 100;
            
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
            progressText.textContent = `Samples: ${data.samples_collected}/${data.total_samples}`;
            
            if (data.in_progress) {
              setTimeout(updateProgress, 5000); // Update every 5 seconds while in progress
            }
          });
      }
      
      // Start progress and email status updates when page loads
      document.addEventListener('DOMContentLoaded', () => {
        updateProgress();
        updateEmailStatus();
        // Update email status every 30 seconds
        setInterval(updateEmailStatus, 30000);
      });
    </script>
  </head>
  <body>
    <div class="term">
      <div class="term-header">BPI Collector — Terminal Dashboard</div>
      <div class="term-body">
          <!-- Chart Row -->
          <div class="chart-row">
            <div class="panel" style="height: 100%;">
              <h3>$ Price History</h3>
              <div class="chart-container">
                <canvas id="chart"></canvas>
              </div>
            </div>
          </div>

          <!-- Data Row -->
          <div class="data-row">
            <!-- Status Panel -->
            <div class="panel">
              <h3>System Status</h3>
              <div class="status active">
                <span id="status">Connected</span>
              </div>
              <div class="progress-container" style="margin-top: 10px;">
                <div class="progress-bar" id="collection-progress" style="width: 0%">0%</div>
              </div>
              <div id="progress-text" style="margin-top: 5px; font-size: 12px;">
                Samples: 0/0
              </div>
              <div id="email-status" style="margin-top: 10px; font-size: 12px;">
                Last Email: Not sent
              </div>
              
              <h4 style="margin-top: 20px; margin-bottom: 5px;">Email History</h4>
              <div id="email-history" class="email-history">
                <!-- Email history items will be inserted here -->
              </div>
            </div>

            <!-- Price Range Panel -->
            <div class="panel">
              <h3>Price Range</h3>
              <div class="gauges">
                <div class="gauge">
                  <div class="gauge-label">Minimum</div>
                  <div id="gauge-min" class="gauge-value">—</div>
                </div>
                <div class="gauge">
                  <div class="gauge-label">Maximum</div>
                  <div id="gauge-max" class="gauge-value">—</div>
                </div>
              </div>
            </div>

            <!-- Latest Samples -->
            <div class="panel">
              <h3>Latest Samples</h3>
              <div class="sample-counter">
                <span>Total Samples</span>
                <span id="sample-count" class="counter-value">0</span>
              </div>
              <div class="samples-wrap">
                <table id="samples">
                  <thead>
                    <tr>
                      <th>Timestamp</th>
                      <th>Price (USD)</th>
                      <th>Change</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
      </div>
    </div>

    <script src="/static/live.js"></script>
  </body>
</html>
